<div class="appointments-container">
  <!-- En-tête principale avec un titre et une description -->
  <header class="appointments-header">
    <h1 class="big-title">Bienvenue sur votre espace de rendez-vous</h1>
    <p class="subtitle">
      Simplifiez votre vie en réservant vos rendez-vous en quelques clics.
      Suivez les étapes et laissez-nous nous occuper du reste.
    </p>
    <!-- Bouton pour afficher/masquer le formulaire de prise de rendez-vous -->
    <button class="new-appointment-btn" (click)="toggleAddForm()">
      {{ showAddForm ? 'Fermer le formulaire' : 'Prendre un rendez-vous' }}
    </button>
  </header>

  <!-- Formulaire d'ajout/modification de rendez-vous -->
  <div *ngIf="showAddForm" class="appointment-form">
    <h2>{{ editingAppointment ? 'Modifier votre rendez-vous' : 'Planifiez un nouveau rendez-vous' }}</h2>
    <p class="form-instructions">
      Remplissez les champs ci-dessous avec précision pour garantir une réservation réussie.
    </p>

    <!-- Formulaire lié au FormGroup de Angular -->
    <form [formGroup]="appointmentForm" (ngSubmit)="submitAppointment()">

      <!-- Sélection du service -->
      <div class="form-group">
        <label for="service">Service *</label>
        <select id="service" formControlName="serviceId" required>
          <option value="">Choisissez un service</option>
          <option *ngFor="let service of services" [value]="service.id">
            {{ service.name }} (Durée : {{ service.duration }} min)
          </option>
        </select>
      </div>

      <!-- Sélection de la date -->
      <div class="form-group">
        <label for="date">Date *</label>
        <input
          type="date"
          id="date"
          formControlName="appointmentDate"
          required
          [min]="minDate"
        (change)="onDateChange()"
        />
      </div>

      <!-- Sélection de l'heure -->
      <div class="form-group">
        <label for="time">Heure *</label>
        <select formControlName="time" id="time" required>
          <option value="" disabled>Choisissez un créneau</option>
          <option *ngFor="let slot of availableTimeSlots" [value]="slot">
            {{ slot }}
          </option>
        </select>
      </div>

      <!-- Notes optionnelles -->
      <div class="form-group">
        <label for="note">Notes</label>
        <textarea
          maxlength="150"
          id="note"
          formControlName="note"
          placeholder="Ajoutez une note brève pour les pharmaciens..."
        ></textarea>
        <p id="charCount">150 caractères maximum.</p>
      </div>

      <!-- Script pour afficher le nombre de caractères restants dans la note -->
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const textarea = document.getElementById('note');
          const charCount = document.getElementById('charCount');

          if (textarea && charCount) {
            textarea.addEventListener('input', () => {
              const currentLength = textarea.value.length; // Longueur du texte actuel
              const maxLength = textarea.getAttribute('maxlength'); // Longueur max
              charCount.textContent = `${currentLength}/${maxLength} caractères`;
            });
          } else {
            console.error("Impossible de trouver l'élément textarea ou charCount");
          }
        });
      </script>

      <!-- Boutons d'action -->
      <div class="form-actions">
        <button
          type="submit"
          [disabled]="!appointmentForm.valid"
          class="submit-btn"
        >
          {{ editingAppointment ? 'Mettre à jour' : 'Confirmer' }}
        </button>
        <button type="button" (click)="toggleAddForm()" class="cancel-btn">
          Annuler
        </button>

        <p class="asterix">Le petit (*) signifie que les champs sont obligatoires.</p>
      </div>
    </form>
  </div>

  <!-- Liste des rendez-vous existants -->
  <div class="appointments-list">
    <h2 class="title2">Vos rendez-vous</h2>
    <p class="subtitle">
      Consultez vos rendez-vous ci-dessous. Vous pouvez les modifier ou les
      annuler si nécessaire. Toutefois, les pharmaciens se réservent le droit d'annuler un rendez-vous, veuillez surveiller vos e-mails.
    </p>

    <!-- Message affiché s'il n'y a aucun rendez-vous -->
    <div *ngIf="appointments.length === 0" class="no-data">
      Aucun rendez-vous trouvé. Cliquez sur "Prendre un rendez-vous" pour en
      ajouter un.
    </div>

    <!-- Affichage des rendez-vous sous forme de carte -->
    <div *ngIf="appointments.length > 0" class="appointments-grid">
      <div *ngFor="let appointment of appointments" class="appointment-card">
        <div class="appointment-details">
          <h3>{{ appointment.service?.name }}</h3>
          <p><strong>Date :</strong> {{ appointment.appointmentDate | date: 'dd/MM/yyyy' }}</p>
          <p><strong>Heure :</strong> {{ appointment.time }}</p>
          <p><strong>Notes :</strong> {{ appointment.note || 'Aucune'}}</p>

          <!-- Affichage du statut avec des classes CSS dynamiques -->
          <p
            class="status"
            [ngClass]="{
              'text-pending': appointment.status === 'en attente',
              'text-canceled': appointment.status === 'annulé',
              'text-confirmed': appointment.status === 'confirmé'
            }"
          >
            <strong>Statut :</strong> {{ appointment.status }}
          </p>
        </div>

        <!-- Boutons pour modifier ou annuler un rendez-vous -->
        <div class="appointment-actions">
          <button (click)="editAppointment(appointment)" class="edit-btn">Modifier</button>
          <button (click)="confirmCancel(appointment)" class="cancel-btn">Annuler</button>
        </div>
      </div>
    </div>
  </div>
</div>
