<div class="products-container">
  <header class="page-header">
    <h2>Gestion des Produits</h2>
    <button class="add-btn" (click)="toggleAddForm()">
      Ajouter un produit
    </button>
  </header>

  <!-- Formulaire d'ajout -->
  <div *ngIf="showAddForm" class="form-container">
    <h3>{{ editingProduct ? 'Modifier le produit' : 'Ajouter un produit' }}</h3>
    <form (ngSubmit)="onSubmit()" #productForm="ngForm">
      <div class="form-group">
        <label for="name">Nom du produit*</label>
        <input
          id="name"
          [(ngModel)]="newProduct.name"
          name="name"
          required
          type="text"
          placeholder="Ex: Crème hydratante"
        />
      </div>

      <div class="form-group">
        <label for="description">Description*</label>
        <textarea
          id="description"
          [(ngModel)]="newProduct.description"
          name="description"
          required
          rows="3"
          placeholder="Décrivez le produit..."
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="price">Prix (€)*</label>
          <input
            id="price"
            [(ngModel)]="newProduct.price"
            name="price"
            required
            type="number"
            min="0"
            step="0.01"
          />
        </div>

        <div class="form-group">
          <label for="stock">Stock*</label>
          <input
            id="stock"
            [(ngModel)]="newProduct.stock"
            name="stock"
            required
            type="number"
            min="0"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="typeId">Catégorie*</label>
        <select
          id="typeId"
          name="typeId"
          [(ngModel)]="newProduct.typeId"
          required
        >
          <option value="">Sélectionner une catégorie</option>
          <option *ngFor="let type of types" [value]="type.id_type">
            {{ type.name }}
          </option>
        </select>
      </div>

      <div class="avatar-container">
        <input type="file"  (change)="onFileSelected($event)" accept="image/*" />
      </div>

      <div class="form-actions">
        <button type="submit" class="save-btn" [disabled]="!productForm.valid">
          {{ editingProduct ? 'Mettre à jour' : 'Ajouter' }}
        </button>
        <button type="button" class="cancel-btn" (click)="toggleAddForm()">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des produits -->
  <div class="products-grid">
    <div *ngFor="let product of products" class="product-card">
      <div class="product-content">
        <h3>{{ product.name }}</h3>
        <p class="description">{{ product.description }}</p>
        <div class="product-info">
          <div class="price-stock">
                <span class="price" [class.original-price]="product.activePromotion">
                  {{ product.price | currency:'EUR' }}
                </span>
            <span *ngIf="product.activePromotion" class="promotion-price">
                  {{ (product.price * (1 - product.activePromotion.discountPercentage / 100)) | currency:'EUR' }}
                </span>
            <span class="stock" [class.low-stock]="product.stock < 5">
                  Stock: {{ product.stock }}
                </span>
          </div>

          <!-- Gestion des promotions -->
          <div class="promotion-controls">
            <select class="promotion-select" [(ngModel)]="product.selectedPromotionId">
              <option [ngValue]="null">Sélectionner une promotion</option>
              <option *ngFor="let promo of availablePromotions" [value]="promo.id_promotion">
                {{ promo.description }} (-{{ promo.discountPercentage }}%)
              </option>
            </select>
            <button
              class="promotion-btn apply"
              (click)="applyPromotion(product, product.selectedPromotionId)"
              [disabled]="product.selectedPromotionId === undefined || product.selectedPromotionId === null"
            >
              Appliquer
            </button>
          </div>
        </div>
      </div>

      <div class="product-actions">
        <button class="edit-btn" (click)="editProduct(product)">
          Modifier
        </button>
        <button class="delete-btn" (click)="deleteProduct(product.id_product)">
          Supprimer
        </button>
      </div>
    </div>
    <div *ngIf="products.length === 0" class="no-data">Aucun produit disponible</div>
  </div>
</div>
