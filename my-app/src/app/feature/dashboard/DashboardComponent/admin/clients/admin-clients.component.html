<div class="admin-layout">

  <!-- Contenu principal de la page d'administration -->
  <main class="main-content">

    <!-- Barre supérieure avec le titre de la page -->
    <header class="top-bar">
      <h1>Administration Ghoan Medic - Client</h1>
    </header>

    <div class="content">

      <!-- Conteneur de la table des clients -->
      <div class="table-container">

        <!-- Barre de filtres pour rechercher un client et filtrer par statut -->
        <div class="filter-bar">
          <input
            type="text"
            placeholder="Rechercher par nom ou prénom..."
            (input)="filterClients($event)"
            class="filter-input"
          />
          <select (change)="filterByStatus($event)" class="filter-select">
            <option value="all">Tous</option>
            <option value="true">Actif</option>
            <option value="false">Inactif</option>
          </select>
        </div>

        <!-- Tableau des clients -->
        <table>
          <thead>
          <tr>
            <th>Avatar</th>
            <th>Nom</th>
            <th>Prénom</th>
            <th>Email</th>
            <th>Adresse</th>
            <th>Statut</th>
            <th>Actif</th>
            <th>Est admin</th>
            <th>Actions</th>
          </tr>
          </thead>
          <tbody>
          <ng-container *ngFor="let client of filteredClients">
            <tr>
              <td>
                <!-- Affichage de l'avatar du client, ou image par défaut -->
                <img
                  [src]="PathUrl + client.avatar || 'assets/default.jpg'"
                  class="avatar-img"
                  alt="Avatar"
                />
              </td>
              <td>{{ client.firstName }}</td>
              <td>{{ client.lastName }}</td>
              <td>{{ client.credential?.mail || 'Erreur' }}</td>
              <td>{{ client.address }}</td>
              <td>
                <!-- Affichage du statut du client (banni ou en règle) -->
                <span [ngClass]="{'text-red': client.credential.ban, 'text-green': !client.credential.ban}">
                    {{ client.credential.ban ? 'Banni' : 'En règle' }}
                  </span>
              </td>
              <td>{{ client.credential.active ? 'actif' : 'désactivé' }}</td>
              <td>{{ client.credential.isAdmin ? 'Oui' : 'Non' }}</td>
              <td class="actions">
                <!-- Actions disponibles pour chaque client -->
                <button class="edit" (click)="openEditClientModal(client)">
                  <i class="fas fa-edit"></i> Modifier
                </button>
                <button class="delete"
                        (click)="onToggleDisableClient(client.clientId)"
                        [class.active]="client.credential.active"
                >
                  {{ client.credential.active ? 'Désactiver' : 'Réactiver' }}
                </button>

                <button class="ban" (click)="BanClient(client.clientId)">
                  <i class="fas fa-ban"></i> Bannir
                </button>
                <button class="view-orders" (click)="openOrdersModal(client)">
                  <i class="fas fa-box"></i> Consulter commandes
                </button>
                <button class="grant-admin" (click)="PutAdminOrNot(client.clientId)">
                  <i class="fas fa-user-shield"></i> Privilèges Admin
                </button>
              </td>
            </tr>
          </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Fenêtre modale pour afficher les commandes d'un client -->
  <div class="modal" *ngIf="isModalOpen">
    <div class="modal-content">
      <span class="close" (click)="closeModal()">&times;</span>
      <h2>Commandes de {{ selectedClient?.firstName }} {{ selectedClient?.lastName }}</h2>

      <!-- Affichage des commandes du client -->
      <table class="orders-table" *ngIf="selectedClientOrders.length > 0">
        <thead>
        <tr>
          <th>Identifiant</th>
          <th>Date de la commande</th>
          <th>Montant total</th>
          <th>Statut</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let order of selectedClientOrders">
          <td>{{ order.id_client }}</td>
          <td>{{ order.date_order | date: 'dd/MM/yyyy' }}</td>
          <td>{{ order.montant_total | currency: 'EUR' }}</td>
          <td>
            <!-- Affichage du statut de la commande avec une conversion -->
            {{ order.id_statut === 1 ? 'Pending' :
            order.id_statut === 2 ? 'Paid' :
              order.id_statut === 3 ? 'Processing' :
                order.id_statut === 4 ? 'Shipped' :
                  order.id_statut === 5 ? 'Delivered' :
                    order.id_statut === 6 ? 'Cancelled' : 'Unknown' }}
          </td>
          <button class="view-orders" routerLink="/admin/orders">Gérer</button>
        </tr>
        </tbody>
      </table>

      <!-- Message si aucune commande n'a été trouvée -->
      <p *ngIf="selectedClientOrders.length === 0">
        Aucune commande trouvée.
      </p>
    </div>
  </div>

  <!-- Fenêtre modale pour modifier les informations d'un client -->
  <div class="modal" *ngIf="isEditModalOpen">
    <div class="modal-content">
      <span class="close" (click)="closeEditModal()">&times;</span>
      <h2>Modifier le client</h2>
      <p>{{ selectedClient?.firstName }} {{ selectedClient?.lastName }}</p>

      <!-- Formulaire pour éditer les informations d'un client -->
      <form (ngSubmit)="saveClientEdits()" class="edit-form">
        <div class="form-group">
          <label for="firstName">Prénom :</label>
          <input
            id="firstName"
            type="text"
            [(ngModel)]="editedClientData.firstName"
            name="firstName"
            required
          />
        </div>

        <div class="form-group">
          <label for="lastName">Nom :</label>
          <input
            id="lastName"
            type="text"
            [(ngModel)]="editedClientData.lastName"
            name="lastName"
            required
          />
        </div>

        <div class="form-group">
          <label for="address">Adresse :</label>
          <textarea
            id="address"
            [(ngModel)]="editedClientData.address"
            name="address"
          ></textarea>
        </div>

        <!-- Boutons d'action pour enregistrer ou annuler -->
        <div class="modal-actions">
          <button type="button" class="btn cancel" (click)="closeEditModal()">Annuler</button>
          <button type="submit" class="btn save">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>
</div>
